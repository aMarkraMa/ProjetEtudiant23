<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.projet.mapper.BinomeMapper">
    
    <resultMap id="resultMapBinome" type="binome">
        <id property="idBinome" column="id_binome"/>
        <result column="date_reelle_remise" property="dateReelleRemise"/>
        <association property="projet" javaType="projet">
            <id column="id_projet" property="idProjet"/>
            <result column="nom_matiere" property="nomMatiere"/>
            <result column="sujet" property="sujet"/>
            <result column="date_prevue_remise" property="datePrevueRemise"/>
        </association>
        <collection property="etudiants" ofType="etudiant">
            <id column="id_etudiant" property="idEtudiant"/>
            <result column="nom_etudiant" property="nomEtudiant"/>
            <result column="prenom_etudiant" property="prenomEtudiant"/>
            <association property="formation" javaType="formation" column="id_formation" select="com.projet.mapper.FormationMapper.selectById"/>
        </collection>
    </resultMap>

    <select id="selectAll" resultMap="resultMapBinome" resultType="binome">
        SELECT b.id_binome,
               b.id_projet,
               e.id_etudiant,
               e.nom_etudiant,
               e.prenom_etudiant,
               b.date_reelle_remise,
               f.id_formation,
               f.nom_formation,
               f.promotion,
               p.nom_matiere,
               p.sujet,
               p.date_prevue_remise
        FROM etudiants e,
             appartenir a,
             binomes b,
             formations f,
             projets p
        WHERE e.id_formation = f.id_formation
          AND e.id_etudiant = a.id_etudiant
          AND a.id_binome = b.id_binome
          AND a.id_projet = b.id_projet
          AND b.id_projet = p.id_projet
    </select>

    <select id="selectByIdBinomeAndIdProjet" resultType="binome" resultMap="resultMapBinome">
        SELECT b.id_binome,
               b.id_projet,
               e.id_etudiant,
               e.nom_etudiant,
               e.prenom_etudiant,
               b.date_reelle_remise,
               f.id_formation,
               f.nom_formation,
               f.promotion,
               p.nom_matiere,
               p.sujet,
               p.date_prevue_remise
        FROM etudiants e,
             appartenir a,
             binomes b,
             formations f,
             projets p
        WHERE e.id_formation = f.id_formation
          AND e.id_etudiant = a.id_etudiant
          AND a.id_binome = b.id_binome
          AND a.id_projet = b.id_projet
          AND b.id_projet = p.id_projet
          AND b.id_binome = #{idBinome}
          AND b.id_projet = #{projet.idProjet}
    </select>


    <insert id="insertBinome">
        BEGIN TRANSACTION;

        INSERT INTO binomes (id_binome, id_projet)
        VALUES (#{idBinome}, #{projet.idProjet});
        
        INSERT INTO appartenir (id_binome, id_projet, id_etudiant)
        VALUES (#{idBinome}, #{projet.idProjet}, #{etudiants[0].idEtudiant})
        
        <if test="etudiants.size() > 1">
            INSERT INTO appartenir (id_binome, id_projet, id_etudiant)
            VALUES (#{idBinome}, #{projet.idProjet}, #{etudiants[1].idEtudiant})
        </if>
        
        COMMIT;

    </insert>
    <delete id="deleteBinome">
        DELETE FROM binomes WHERE id_binome = #{idBinome} AND id_projet = #{idProjet}
    </delete>
    <delete id="deleteById"></delete>

    <update id="updateBinome">
        UPDATE binomes
        <set>
            <if test="etudiant1.idEtudiant != null">id_etudiant1 = #{etudiant1.idEtudiant}</if>
            <if test="etudiant2.idEtudiant != null">id_etudiant2 = #{etudiant2.idEtudiant}</if>
            <if test="dateRelleRemise != null">date_reelle_remise = #{dateReelleRemise}</if>
        </set>
        WHERE id_binome = #{idBinome}
        AND id_projet = #{idProjet}
    </update>






</mapper>